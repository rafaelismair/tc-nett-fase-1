name: CI - Build & Test .NET 8

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v3

    - name: ğŸ§° Instalar .NET 8 Preview
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: ğŸ§¾ Verificar versÃ£o instalada
      run: dotnet --info

    - name: ğŸ” Restaurar pacotes
      run: dotnet restore Fiap.CloudGames.Fase1.sln

    - name: ğŸ› ï¸ Build do projeto
      run: dotnet build Fiap.CloudGames.Fase1.sln --configuration Release --no-restore

    - name: ğŸ§ª Executar testes (Release)
      run: |
        dotnet test Fiap.CloudGames.Fase1.Tests/Fiap.CloudGames.Fase1.Tests.csproj \
          --configuration Release \
          --no-restore \
          --no-build \
          --verbosity normal
  deploy:
    name: ğŸš€ Deploy para Azure Web App
    runs-on: ubuntu-latest
    needs: build-and-test

    env:
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
      CONTAINER_REGISTRY: ${{ secrets.CONTAINER_REGISTRY }}
      IMAGE_REPOSITORY: ${{ secrets.IMAGE_REPOSITORY }}
      DOCKERFILE_PATH: ${{ secrets.DOCKERFILE_PATH }}
      WEBAPP_NAME: ${{ secrets.WEBAPP_NAME }}

    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ³ Login no Azure Container Registry (ACR)
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.CONTAINER_REGISTRY }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: ğŸ—ï¸ Build e Push da imagem para o ACR
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ env.DOCKERFILE_PATH }}
        push: true
        tags: ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_REPOSITORY }}:latest

    - name: ğŸš€ Atualizar Web App para nova imagem
      run: |
        az webapp config container set \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --docker-custom-image-name ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_REPOSITORY }}:latest \
          --docker-registry-server-url https://${{ env.CONTAINER_REGISTRY }}


